C51 COMPILER V9.60.0.0   TRAFFIC_LIGHT                                                     12/14/2022 21:01:35 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE TRAFFIC_LIGHT
OBJECT MODULE PLACED IN .\Objects\traffic_light.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE traffic_light.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\List
                    -ings\traffic_light.lst) TABS(2) OBJECT(.\Objects\traffic_light.obj)

line level    source

   1          #include "headfile.h"
   2          
   3          #define DONT_DISPLAY 255 // DisplayDigitå‡½æ•°çš„valä¸ºè¯¥å€¼æ—¶ï¼Œä¸¤ä½å‡ä¸æ˜¾ç¤º
   4          #define SEG_OFF 15       // Write7219å‘æŸä½æ•°ç ç®¡å†™å…¥è¯¥å€¼æ—¶ï¼Œè¯¥ä½æ•°ç ç®¡ä¸æ˜¾ç¤º
   5          
   6          static uchar last_display_val[DIRECTION_MAX];
   7          digs_addr code ONES_BIT[] = {EAST_ONES, SOUTH_ONES, WEST_ONES, NORTH_ONES};
   8          digs_addr code TENS_BIT[] = {EAST_TENS, SOUTH_TENS, WEST_TENS, NORTH_TENS};
   9          uchar remain_time[DIRECTION_MAX];
  10          uchar light_time[DIRECTION_MAX][3]; // å­˜æ”¾å››ä¸ªæ–¹å‘çš„ä¸‰è‰²ç¯çš„è®¾ç½®æ—¶é—´,ç¬¬ä¸€ç»´åº¦ä¸ºdir,ç¬
             -¬äºŒç»´åº¦ä¸ºcolor
  11          uchar current_color[DIRECTION_MAX];
  12          TrafficLightColor next_status;
  13          
  14          void TrafficLightInit()
  15          {
  16   1          /**
  17   1           * @brief åˆå§‹åŒ–äº¤é€šç¯çš„å€¼
  18   1           * @todo æ³¨æ„ä¿®æ”¹åˆå§‹æ—¶é—´
  19   1           */
  20   1          uchar i;
  21   1          for (i = 0; i < TRAFFIC_LIGHT_MAX; i++)
  22   1          {
  23   2              SetLedBit(i, LED_OFF); // å…³æ‰æ‰€æœ‰ç¯
  24   2          }
  25   1      
  26   1          remain_time[EAST] = light_time[EAST][GREEN];
  27   1          remain_time[SOUTH] = remain_time[EAST] + light_time[EAST][YELLOW];
  28   1          remain_time[WEST] = remain_time[SOUTH] + light_time[SOUTH][GREEN] + light_time[SOUTH][YELLOW];
  29   1          remain_time[NORTH] = remain_time[WEST] + light_time[WEST][GREEN] + light_time[WEST][YELLOW];
  30   1      
  31   1          // remain_time[EAST] = 15;
  32   1          // remain_time[SOUTH] = 20;
  33   1          // remain_time[WEST] = 40;
  34   1          // remain_time[NORTH] = 60;
  35   1      
  36   1          SetLedColor(EAST, GREEN);
  37   1          SetLedColor(SOUTH, RED);
  38   1          SetLedColor(WEST, RED);
  39   1          SetLedColor(NORTH, RED);
  40   1      }
  41          
  42          void Write7219(unsigned char address, unsigned char dat)
  43          {
  44   1          unsigned char i;
  45   1          LOAD_7219 = 0; // æ‹‰ä½ç‰‡é€‰çº¿ï¼Œé€‰ä¸­å™¨ä»¶
  46   1          // å‘é€åœ°å€
  47   1          for (i = 0; i < 8; i++) // ç§»ä½å¾ªç¯8æ¬¡
  48   1          {
  49   2              CLK_7219 = 0;                     // æ¸…é›¶æ—¶é’Ÿæ€»çº¿
  50   2              DIN_7219 = (bit)(address & 0x80); // æ¯æ¬¡å–é«˜å­—èŠ‚
  51   2              address <<= 1;                    // å·¦ç§»ä¸€ä½
  52   2              CLK_7219 = 1;                     // æ—¶é’Ÿä¸Šå‡æ²¿ï¼Œå‘é€åœ°å€
  53   2          }
C51 COMPILER V9.60.0.0   TRAFFIC_LIGHT                                                     12/14/2022 21:01:35 PAGE 2   

  54   1          // å‘é€æ•°æ®
  55   1          for (i = 0; i < 8; i++)
  56   1          {
  57   2              CLK_7219 = 0;
  58   2              DIN_7219 = (bit)(dat & 0x80);
  59   2              dat <<= 1;
  60   2              CLK_7219 = 1; // æ—¶é’Ÿä¸Šå‡æ²¿ï¼Œå‘é€æ•°æ®
  61   2          }
  62   1          LOAD_7219 = 1; // å‘é€ç»“æŸï¼Œä¸Šå‡æ²¿é”å­˜æ•°æ®
  63   1      }
  64          
  65          // MAX7219åˆå§‹åŒ–ï¼Œè®¾ç½®MAX7219å†…éƒ¨çš„æ§åˆ¶å¯„å­˜å™¨
  66          void Init7219(void)
  67          {
  68   1          Write7219(SHUT_DOWN, 0x01);    // å¼€å¯æ­£å¸¸å·¥ä½œæ¨¡å¼ï¼ˆ0xX1ï¼‰
  69   1          Write7219(DISPLAY_TEST, 0x00); // é€‰æ‹©å·¥ä½œæ¨¡å¼ï¼ˆ0xX0ï¼‰
  70   1          Write7219(DECODE_MODE, 0xff);  // é€‰ç”¨å…¨è¯‘ç æ¨¡å¼
  71   1          Write7219(SCAN_LIMIT, 0x07);   // 8åªLEDå…¨ç”¨
  72   1          Write7219(INTENSITY, 0x04);    // è®¾ç½®åˆå§‹äº®åº¦
  73   1      }
  74          
  75          void DisplayDigit(uchar val, direction dir)
  76          {
  77   1          // @brief åœ¨diræ–¹å‘å±•ç¤ºval,å¹¶å°†æœ¬æ¬¡æ˜¾ç¤ºçš„å€¼ä¿å­˜åœ¨last_å˜é‡ä¸­
  78   1          // @note  è¿™æ˜¯å”¯ä¸€å…è®¸è°ƒç”¨æ•°ç ç®¡æ˜¾ç¤ºçš„æ–¹å¼
  79   1          static uchar ones, tens;
  80   1      
  81   1          if (val == DONT_DISPLAY)
  82   1          {
  83   2              // ä¸¤ä½å‡ä¸æ˜¾ç¤º
  84   2              ones = SEG_OFF;
  85   2              tens = SEG_OFF;
  86   2          }
  87   1          else
  88   1          {
  89   2              ones = val % 10;
  90   2              tens = (val / 10 % 10) == 0 ? SEG_OFF : (val / 10 % 10); // å¦‚æœåä½ä¸º0ï¼Œåˆ™ä¸æ˜¾ç¤º
  91   2          }
  92   1      
  93   1          Write7219(ONES_BIT[dir], ones);
  94   1          Write7219(TENS_BIT[dir], tens);
  95   1      
  96   1          if (val == DONT_DISPLAY)
  97   1              last_display_val[dir] = last_display_val[dir]; // ä¸ä¿å­˜ç©ºç™½ä½ç½®
  98   1          else
  99   1              last_display_val[dir] = val;
 100   1      }
 101          
 102          void DisplayDigitDemo()
 103          {
 104   1          Write7219(1, 1); // 15ä¸ºå…¨ç­
 105   1          Write7219(2, 2);
 106   1          Write7219(3, 3);
 107   1          Write7219(4, 4);
 108   1          Write7219(5, 5);
 109   1          Write7219(6, 6);
 110   1          Write7219(7, 7);
 111   1          Write7219(8, 8);
 112   1          // Write7219(1, 15); // 15ä¸ºå…¨ç­
 113   1      }
 114          
 115          void TrafficLightMain()
C51 COMPILER V9.60.0.0   TRAFFIC_LIGHT                                                     12/14/2022 21:01:35 PAGE 3   

 116          {
 117   1          direction dir;
 118   1          if (new_second_flag)
 119   1          {
 120   2              for (dir = 0; dir < DIRECTION_MAX; dir++)
 121   2              {
 122   3                  remain_time[dir]--;       // å„æ–¹å‘å€’è®¡æ—¶æ›´æ–°
 123   3                  if (remain_time[dir] < 5) // åˆ¤æ–­æ˜¯å¦éœ€è¦é—ªçƒ
 124   3                  {
 125   4                      if (current_color[dir] == YELLOW)
 126   4                          ToggleLedBit(GetDstLed(dir, YELLOW));
 127   4                  }
 128   3                  if (remain_time[dir] <= 0)
 129   3                  {
 130   4                      // è£…è½½ä¸‹ä¸€ä¸ªçŠ¶æ€
 131   4                      next_status = (current_color[dir] + 1 >= TRAFFIC_LIGHT_STATUS_MAX) ? (RED) : (current_colo
             -r[dir] + 1);
 132   4                      // remain_time[dir] = GetReloadValue(next_status, dir);
 133   4                      remain_time[dir] = light_time[dir][next_status];
 134   4                      SetLedColor(dir, next_status);
 135   4                  }
 136   3      
 137   3                  // æ•°ç ç®¡æ˜¾ç¤ºå‰©ä½™ç§’æ•°
 138   3                  DisplayDigit(remain_time[dir], dir);
 139   3              }
 140   2              new_second_flag = 0; // æ¸…é™¤æ ‡å¿—ä½
 141   2          }
 142   1          else
 143   1              return;
 144   1      }
 145          
 146          void SettingMain()
 147          {
 148   1          direction dir = EAST;
 149   1          uchar time_out_flag = 0;
 150   1          TrafficLightColor color = RED;
 151   1      
 152   1          for (dir = EAST; dir < DIRECTION_MAX; dir++)
 153   1          {
 154   2              SetLedColor(dir, RED); // å…¨éƒ¨ç½®ä¸ºçº¢ç¯
 155   2          }
 156   1      
 157   1          while (mode == SETTING)
 158   1          {
 159   2              for (dir = EAST; dir < DIRECTION_MAX && mode == SETTING; dir++)
 160   2              {
 161   3                  for (color = RED; color < TRAFFIC_LIGHT_STATUS_MAX && mode == SETTING; color++)
 162   3                  {
 163   4                      while (mode == SETTING)
 164   4                      {
 165   5                          if (SWITCH_KEY == 0)
 166   5                          {
 167   6                              DelayMS(100);
 168   6                              if (SWITCH_KEY == 0)
 169   6                                  break;
 170   6                          }
 171   5                          if (new_second_flag_setting)
 172   5                          {
 173   6                              DisplayDigit(light_time[dir][color], dir);
 174   6                              ToggleSegs(dir);
 175   6                              new_second_flag_setting = 0;
 176   6                          }
C51 COMPILER V9.60.0.0   TRAFFIC_LIGHT                                                     12/14/2022 21:01:35 PAGE 4   

 177   5                          if (UP_KEY == 0)
 178   5                          {
 179   6                              DelayMS(100);
 180   6                              if (UP_KEY == 0)
 181   6                                  light_time[dir][color]++;
 182   6                          }
 183   5                          if (DOWN_KEY == 0)
 184   5                          {
 185   6                              DelayMS(100);
 186   6                              if (DOWN_KEY == 0)
 187   6                                  light_time[dir][color]--;
 188   6                          }
 189   5                      }
 190   4                  }
 191   3                  DisplayDigit(light_time[dir][RED], dir);
 192   3              }
 193   2          }
 194   1          ClockReset();       // é‡ç½®æ—¶é’Ÿ
 195   1          TrafficLightInit(); // é‡æ–°åˆå§‹åŒ–
 196   1          mode = RUNNING;
 197   1          // EA = 1;
 198   1      }
 199          
 200          void ClockReset()
 201          {
 202   1          // @brief é‡ç½®å®šæ—¶å™¨0ä»¥åŠæ¯«ç§’ã€ç§’è®¡æ•°å™¨
 203   1          TR0 = 0;    // å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 204   1          ET0 = 0;    // å…³é—­å®šæ—¶å™¨0ä¸­æ–­
 205   1          TL0 = 0x20; // è®¾ç½®å®šæ—¶åˆå§‹å€¼
 206   1          TH0 = 0xD1; // è®¾ç½®å®šæ—¶åˆå§‹å€¼
 207   1          milliseconds = 0;
 208   1          seconds = 0;
 209   1          ET0 = 1;
 210   1          TR0 = 1; // å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
 211   1      }
 212          
 213          void ToggleSegs(direction dir)
 214          {
 215   1          // @note: å‘æ–¹å‘å†™å…¥DONT_DISPLAYå¯ä»¥ä½¿æ•°ç ç®¡ç†„ç­
 216   1          static uchar ON[4] = {1, 1, 1, 1}; // 4ä¸ªæ–¹å‘çš„å¼€å…³çŠ¶æ€
 217   1          if (ON[dir] == 1)
 218   1          {
 219   2              DisplayDigit(DONT_DISPLAY, dir);
 220   2              ON[dir] = 0;
 221   2          }
 222   1          else
 223   1          {
 224   2              DisplayDigit(last_display_val[dir], dir);
 225   2              ON[dir] = 1;
 226   2          }
 227   1      }
 228          
 229          void SetLedColor(direction dir, TrafficLightColor color)
 230          {
 231   1          /**
 232   1           * @brief è®¾ç½®diræ–¹å‘çš„ç¯è‰²
 233   1           * @ref å‚è§TrafficLightæšä¸¾
 234   1           * @warning åœ¨é«˜é¢‘è°ƒç”¨è¯¥å‡½æ•°æ—¶ä¼šä½¿è¾“å‡ºç”µå¹³å‡ºç°æš‚æ€ï¼Œå½±å“ç¨³å®šæ€§
 235   1           */
 236   1          SetLedBit(GetDstLed(dir, current_color[dir]), LED_OFF);
 237   1          SetLedBit(GetDstLed(dir, color), LED_ON);
 238   1          current_color[dir] = color;
C51 COMPILER V9.60.0.0   TRAFFIC_LIGHT                                                     12/14/2022 21:01:35 PAGE 5   

 239   1      }
 240          
 241          uchar GetDstLed(direction dir, TrafficLightColor color)
 242          {
 243   1          /**
 244   1           * @brief è·å–diræ–¹å‘coloré¢œè‰²çš„LEDå¯¹åº”çš„LEDsæšä¸¾å˜é‡
 245   1           */
 246   1          uchar dst_led = 0;
 247   1          switch (dir)
 248   1          {
 249   2          case NORTH:
 250   2              dst_led = 0;
 251   2              break;
 252   2          case WEST:
 253   2              dst_led = 3;
 254   2              break;
 255   2          case SOUTH:
 256   2              dst_led = 6;
 257   2              break;
 258   2          case EAST:
 259   2              dst_led = 9;
 260   2              break;
 261   2          default:
 262   2              break;
 263   2          }
 264   1          switch (color)
 265   1          {
 266   2          case GREEN:
 267   2              break;
 268   2          case YELLOW:
 269   2              dst_led += 1;
 270   2              break;
 271   2          case RED:
 272   2              dst_led += 2;
 273   2              break;
 274   2          default:
 275   2              break;
 276   2          }
 277   1          return dst_led;
 278   1      }
 279          
 280          void EmergencyMain()
 281          {
 282   1      }
 283          
 284          void LoadDefaultTime()
 285          {
 286   1          // åŠ è½½åˆå§‹çŠ¶æ€å„è·¯å£æ—¶é—´
 287   1          light_time[EAST][RED] = 60, light_time[EAST][YELLOW] = 5, light_time[EAST][GREEN] = 15;
 288   1          light_time[SOUTH][RED] = 60, light_time[SOUTH][YELLOW] = 5, light_time[SOUTH][GREEN] = 15;
 289   1          light_time[WEST][RED] = 60, light_time[WEST][YELLOW] = 5, light_time[WEST][GREEN] = 15;
 290   1          light_time[NORTH][RED] = 60, light_time[NORTH][YELLOW] = 5, light_time[NORTH][GREEN] = 15;
 291   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    862    ----
   CONSTANT SIZE    =      8    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     31       7
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.60.0.0   TRAFFIC_LIGHT                                                     12/14/2022 21:01:35 PAGE 6   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
